### ä¸€ã€è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜

| ç¼–å· | ç—›ç‚¹æè¿°                                           | å½±å“                                  |
| ---- | -------------------------------------------------- | ------------------------------------- |
| P1   | **å±€åŸŸç½‘ Agent æ— å…¬ç½‘æ¥å£**ï¼Œéš¾ä»¥è¢«å¤–éƒ¨è°ƒç”¨        | èƒ½åŠ›æ— æ³•å¯¹å¤–æš´éœ²ï¼Œé˜»ç¢ç”Ÿæ€äº’è”        |
| P2   | **HTTP â†” å†…éƒ¨æœåŠ¡** åè®®ä¸ç»Ÿä¸€ï¼Œéƒ¨ç½²å—é™äºæ¡†æ¶     | æ¯æ¢ä¸€å¥—æ¡†æ¶å°±è¦é‡å†™ä»£ç†é€»è¾‘          |
| P3   | **NAT / é˜²ç«å¢™ç©¿é€å¤æ‚**                           | ä¼ ç»Ÿç«¯å£æ˜ å°„æˆ– VPN æ–¹æ¡ˆæˆæœ¬é«˜ã€ä¸ç¨³å®š |
| P4   | **å®‰å…¨ä¸å¤šè·¯å¤ç”¨**ï¼šæ˜æ–‡ WebSocketã€ä¸é™æµã€æ— é‰´æƒ | å®¹æ˜“è¢«åŠ«æŒæˆ–æ‹–å®æœåŠ¡                  |

---

### äºŒã€æ€»ä½“ç›®æ ‡

1. **æ¡†æ¶æ— å…³**ï¼šå‰åç«¯å¯ç”¨ä»»ä½•è¯­è¨€ / æ¡†æ¶ï¼Œåªéœ€éµå®ˆç»Ÿä¸€æ¶ˆæ¯æ ¼å¼ã€‚
2. **å…¨é‡è½¬å‘**ï¼šå®Œæ•´å°è£… HTTP æ–¹æ³•ã€è·¯å¾„ã€Headersã€Queryã€Body ä¸å“åº”ä¿¡æ¯ã€‚
3. **å®‰å…¨å¯é **ï¼šWSSï¼ˆTLSï¼‰+ åŒå‘é‰´æƒ + è¯·æ±‚ ID é…å¯¹ + æ–­çº¿é‡è¿ã€‚
4. **é«˜æ€§èƒ½å¼‚æ­¥**ï¼šçº¯å¼‚æ­¥ IOã€å•è¿æ¥å¤šå¹¶å‘ã€æ— ç£ç›˜è½åœ°ã€‚

---

### ä¸‰ã€æ¶æ„æ¦‚è§ˆ

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            WSS (TLS)           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client    â”‚ â”€HTTPâ†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”€â”€â”€â”€â”€â†’ â”‚  Receiver &  â”‚
â”‚  å¤–éƒ¨è°ƒç”¨è€…  â”‚        â”‚Gateway/Proxy â”‚        â”‚  Internal Appâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†HTTPâ”€ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†â”€â”€â”€â”€â”€ â”‚  (FastAPI â€¦) â”‚
                 â†‘                â†“           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           Request åŒ…è£…       Response åŒ…è£…
```

- **Gateway/Proxyï¼ˆå…¬ç½‘ï¼‰**

  - ç›‘å¬æ‰€æœ‰ HTTP è¯·æ±‚
  - æ‰“åŒ…åé€šè¿‡ **WSS** å‘é€ç»™åç«¯
  - æ”¶åˆ°å“åº”åŒ…åè¿˜åŸæˆ HTTP è¿”å›ç»™ Client

- **Receiverï¼ˆå†…ç½‘ï¼‰**
  - ç»´æŒ WSS é•¿è¿æ¥ï¼Œæ¥æ”¶æ‰“åŒ…è¯·æ±‚
  - è¿˜åŸå¹¶**å†…éƒ¨è°ƒç”¨**æœ¬åœ° Web æ¡†æ¶ï¼ˆç¤ºä¾‹ï¼š`httpx.AsyncClient(app=fastapi_app)`ï¼‰
  - å°†æ¡†æ¶è¿”å›å†…å®¹æ‰“åŒ…ä¸ºå“åº”ï¼Œé€šè¿‡ WSS è¿”è¿˜

---

### å››ã€æ¶ˆæ¯æ ¼å¼

ä½¿ç”¨äºŒè¿›åˆ¶è¯¦ç»†ï¼Œè¯¦ç»†è§ç›¸å…³æ–‡æ¡£ã€‚

[æ¶ˆæ¯æ ¼å¼](./proxy-protocol.md)

---

### äº”ã€å…³é”®æµç¨‹

| æ­¥éª¤ | å‚ä¸æ–¹             | è¯´æ˜                                                      |
| ---- | ------------------ | --------------------------------------------------------- |
| 1    | Gateway            | æ”¶åˆ°å¤–éƒ¨ HTTP è¯·æ±‚ â†’ è§£æäº”å…ƒç»„ â†’ ç”Ÿæˆ `request_id`       |
| 2    | Gateway â†’ Receiver | é€šè¿‡ WSS å‘é€ **Request åŒ…**                              |
| 3    | Receiver           | è§£åŒ… â†’ ç”¨ `httpx.AsyncClient(app=local_app)` ä¼ªé€ å†…éƒ¨è¯·æ±‚ |
| 4    | Internal App       | æ­£å¸¸æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œè¿”å› ASGI Response                      |
| 5    | Receiver           | æ‰“åŒ…ä¸º **Response åŒ…**ï¼ˆå¸¦åŒä¸€ `request_id`ï¼‰             |
| 6    | Receiver â†’ Gateway | WSS å‘é€ Response åŒ…                                      |
| 7    | Gateway            | è¿˜åŸ HTTP å“åº” â†’ å›ç»™å¤–éƒ¨ Client                          |

#### æ—¶åºå›¾ï¼ˆæ–‡æœ¬ç¤ºæ„ï¼‰

```text
Client            Gateway/Proxy          Receiver             Internal App
                    ï¼ˆå…¬ç½‘ï¼‰             ï¼ˆå†…ç½‘ï¼‰
 |                     |                    |                      |
 |---1. HTTP Request-->|                    |                      |
 |                     |---2. WSS Request-->|                      |
 |                     |                    |---3. ASGI Call------>|
 |                     |                    |<--4. ASGI Response---|
 |                     |<--5. WSS Response--|                      |
 |<--6. HTTP Response--|                    |                      |
```

```mermaid
sequenceDiagram
participant C as Client
participant G as Gateway/Proxy (å…¬ç½‘)
participant R as Receiver (å†…ç½‘)
participant A as Internal App


C->>G: 1. HTTP Request
G->>R: 2. WSS å‘é€ Request åŒ…
R->>A: 3. å†…éƒ¨ ASGI è°ƒç”¨
A-->>R: 4. ASGI Response
R-->>G: 5. WSS å‘é€ Response åŒ…
G-->>C: 6. HTTP Response
```

### å…­ã€æŠ€æœ¯é€‰å‹ä¸å®ç°è¦ç‚¹ã€æŠ€æœ¯é€‰å‹ä¸å®ç°è¦ç‚¹ã€æŠ€æœ¯é€‰å‹ä¸å®ç°è¦ç‚¹

| ç»„ä»¶     | å»ºè®®åº“                                | å¤‡æ³¨                              |
| -------- | ------------------------------------- | --------------------------------- |
| WSS é€šé“ | `websockets` / `starlette.websockets` | æ”¯æŒ TLSã€Ping/Pongã€æ–­çº¿è‡ªåŠ¨é‡è¿ |
| è¯·æ±‚å°è£… | `pydantic` / `dataclasses-json`       | ç»Ÿä¸€ Schemaï¼Œæ˜“æ‰©å±•               |
| å†…éƒ¨è°ƒç”¨ | `httpx.AsyncClient(app=app)`          | 0 å¤åˆ¶ ASGI è·¯å¾„ï¼Œé«˜æ€§èƒ½          |
| æµæ§é™é€Ÿ | `asyncio.Semaphore`                   | é˜²æ­¢å•è¿æ¥æ‹–å®åç«¯                |

### ä¸ƒã€å¿«é€Ÿå¼€å§‹

#### ç¯å¢ƒè¦æ±‚

- Python 3.11+
- UV åŒ…ç®¡ç†å™¨
- é…ç½®æ–‡ä»¶ `config.toml`ï¼ˆå¿…éœ€ï¼‰

#### å®‰è£…å’Œè¿è¡Œ

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd anp-proxy

# å®‰è£…ä¾èµ–
uv sync

# è¿è¡ŒæœåŠ¡ï¼ˆä» config.toml åŠ è½½é…ç½®ï¼‰
uv run anp-proxy
```

#### å¯åŠ¨æ–¹å¼

**1. æ ‡å‡†å¯åŠ¨**
```bash
uv run anp-proxy
```

**2. ç®¡ç†è„šæœ¬å¯åŠ¨ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰**
```bash
# åå°å¯åŠ¨
./manage.sh start

# æŸ¥çœ‹çŠ¶æ€
./manage.sh status

# åœæ­¢æœåŠ¡
./manage.sh stop

# é‡å¯æœåŠ¡
./manage.sh restart

# æŸ¥çœ‹æ—¥å¿—
./manage.sh logs
```

**3. å¼€å‘æ¨¡å¼**
```bash
# ç›´æ¥è¿è¡Œ CLI
python anp_proxy/cli.py
```

#### é…ç½®æ–‡ä»¶

é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `config.toml` æ–‡ä»¶åŒ…å«æ‰€æœ‰é…ç½®ï¼š

```toml
# è¿è¡Œæ¨¡å¼ï¼šç›®å‰ä»…æ”¯æŒ gateway
mode = "gateway"

# è°ƒè¯•æ¨¡å¼
debug = false

[logging]
level = "INFO"
format = "%(asctime)s [%(levelname)s] %(name)s: %(message)s"
log_dir = "logs"

[gateway]
# HTTP æœåŠ¡å™¨è®¾ç½®
host = "0.0.0.0"
port = 9877

# è¿æ¥é™åˆ¶
max_connections = 100
timeout = 120.0
keepalive_timeout = 60.0

[gateway.tls]
tls_verify_mode = "required"

[gateway.database]
host = "your-database-host"
port = 3306
user = "username"
password = "password"
database = "did_db"
charset = "utf8mb4"
connect_timeout = 5.0
min_connections = 2
max_connections = 20
```

#### å¯åŠ¨æµç¨‹è¯´æ˜

1. **é…ç½®åŠ è½½**ï¼šCLI ä» `config.toml` åŠ è½½é…ç½® (`anp_proxy/cli.py:44`)
2. **æ—¥å¿—åˆå§‹åŒ–**ï¼šè®¾ç½®æ—¥å¿—çº§åˆ«å’Œè¾“å‡ºç›®å½• (`anp_proxy/app.py:27`)
3. **åº”ç”¨åˆ›å»º**ï¼šåˆ›å»º ANPProxyApp å®ä¾‹ (`anp_proxy/app.py:21`)
4. **æœåŠ¡å¯åŠ¨**ï¼šå¯åŠ¨ Gateway æœåŠ¡ç›‘å¬ç«¯å£ (`anp_proxy/app.py:37`)
5. **ä¼˜é›…åœæ­¢**ï¼šæ”¯æŒ Ctrl+C ä¸­æ–­å’Œèµ„æºæ¸…ç† (`anp_proxy/app.py:52`)

#### ğŸ“Œ ç»“è¯­

é€šè¿‡ **"HTTP â†” WebSocket â†” ASGI"** çš„æ¡¥æ¥æ¨¡å¼ï¼Œä½ å¯ä»¥ï¼š

- **æ— ä¾µå…¥**åœ°ä¸ºå±€åŸŸç½‘ Agent æ‰“å¼€å®‰å…¨ã€å¯æ§çš„å…¬ç½‘å…¥å£
- ä¿ç•™åŸæœ‰æ¡†æ¶ç”Ÿæ€ï¼Œåšåˆ°çœŸæ­£çš„æ¡†æ¶æ— å…³
- ç»Ÿä¸€è¯·æ±‚/å“åº”åè®®åï¼Œæœªæ¥å¯å¹³æ»‘æ¥å…¥å¤šè¯­è¨€ Agent ä¸å¤šäº‘éƒ¨ç½²

å½“å‰ç‰ˆæœ¬ä¸“æ³¨äº Gateway åŠŸèƒ½ï¼Œé…åˆç‹¬ç«‹çš„ octopus é¡¹ç›®å®Œæˆå®Œæ•´çš„ä»£ç†èƒ½åŠ›ã€‚
